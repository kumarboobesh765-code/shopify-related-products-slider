{% if product.collections.size > 0 %}
  {% assign related_collection = product.collections.first %}
{% endif %}

{% if related_collection != blank %}
<div class="rp-wrapper">
  <h2 class="rp-title">Related Products</h2>

  <div class="rp-scroll">

    {% assign shown_products = 0 %}
    {% assign max_products = 8 %}
    {% assign max_soldout = 2 %}

    {% comment %} In-stock products first {% endcomment %}
    {% for rp in related_collection.products %}
      {% if rp.id != product.id and rp.available and shown_products < max_products %}
        {% assign shown_products = shown_products | plus: 1 %}
        <a href="{{ rp.url }}" class="rp-card">
          <div class="rp-img-box">
            <img src="{{ rp.featured_image | image_url: width: 400 }}" alt="{{ rp.title }}" loading="lazy">
          </div>
          <div class="rp-info">
            <p class="rp-name">{{ rp.title }}</p>
            <p class="rp-price">{{ rp.price | money }}</p>
          </div>
        </a>
      {% endif %}
    {% endfor %}

    {% comment %} Few sold-out products {% endcomment %}
    {% assign soldout_count = 0 %}
    {% for rp in related_collection.products %}
      {% if rp.id != product.id and rp.available == false and soldout_count < max_soldout and shown_products < max_products %}
        {% assign soldout_count = soldout_count | plus: 1 %}
        {% assign shown_products = shown_products | plus: 1 %}
        <a href="{{ rp.url }}" class="rp-card rp-sold">
          <div class="rp-img-box">
            <span class="rp-badge">Sold Out</span>
            <img src="{{ rp.featured_image | image_url: width: 400 }}" alt="{{ rp.title }}" loading="lazy">
          </div>
          <div class="rp-info">
            <p class="rp-name">{{ rp.title }}</p>
            <p class="rp-price">{{ rp.price | money }}</p>
          </div>
        </a>
      {% endif %}
    {% endfor %}

  </div>
</div>
{% endif %}

<style>
.rp-wrapper { margin-top: 36px; }
.rp-title { color:#fff;font-size:18px;font-weight:700;margin-bottom:14px;text-transform:uppercase }
.rp-scroll { display:flex;gap:12px;overflow-x:auto;scroll-snap-type:x mandatory;padding-bottom:8px }
.rp-card { min-width:140px;background:#111;border:1px solid #222;border-radius:8px;text-decoration:none;color:#fff;scroll-snap-align:start }
.rp-img-box { width:100%;height:130px;background:#000;display:flex;align-items:center;justify-content:center;position:relative }
.rp-img-box img { max-width:100%;max-height:100%;object-fit:contain }
.rp-badge { position:absolute;top:8px;left:8px;background:#c0392b;color:#fff;font-size:11px;font-weight:700;padding:4px 8px;border-radius:4px;text-transform:uppercase }
.rp-sold img { opacity:0.5 }
.rp-info { padding:8px;text-align:center }
.rp-name { font-size:13px;font-weight:600;line-height:1.25;margin-bottom:4px }
.rp-price { font-size:13px;font-weight:700;color:#f5c542 }
@media(min-width:768px){ .rp-card{min-width:170px} .rp-img-box{height:150px} }
</style>
